name: Run Selenium tests

on:
#   schedule:
#     - cron: '0 5 * * 1-5'
  push:
    branches:
      - "feature/github-actions"
  pull_request:
    branches:
      - "main"

jobs:
  run-selenium-tests:
    runs-on: ubuntu-latest
    env:
      MAVEN_OPTS: -Xmx3200m
    steps:
      # Checkout the code as the first step.
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      # - name: Build with Maven
      #   run: mvn --batch-mode --update-snapshots verify

      # - name: Install latest version of Chrome
      #   run: |
      #     sudo wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub |   sudo apt-key add -
      #     sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
      #     sudo apt-get update
      #     sudo apt-get -y install google-chrome-stable
      # - name: Use ChromeDriver found in repository
      #   run: |
      #     sudo apt-get install libxi6 libgconf-2-4
      #     sudo apt-get -y install xvfb gtk2-engines-pixbuf
      #     sudo apt-get -y install xfonts-cyrillic xfonts-100dpi xfonts-75dpi xfonts-base xfonts-scalable
      #     sudo apt-get install xvfb
      #     sudo apt-get -y install imagemagick x11-apps
      # - name: Running X virtual framebuffer
      #   run: |
      #      Xvfb :0 -ac &
      # - name: Export var
      #   run: |
      #     export DISPLAY=:99

      # - name: Save cache
      #   id: save-cache
      #   uses: actions/cache/save@v3
      #   with:
      #     path: |
      #       ~/.m2
      #     key: v1-dependencies-{{ checksum "pom.xml" }}
          
      #   # run tests!
      # - name: Run Tests
      #   run: |
      #     mvn test
      - name: Run Test
        if: always()
        run: mvn package
        continue-on-error: true

      - name: Get Allure history
        uses: actions/checkout@v2
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Allure Report action from marketplace
        uses: simple-elf/allure-report-action@master
        if: always()
        id: allure-report
        with:
          allure_results: target/allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history

      - name: Deploy report to Github Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v2
        env:
          PERSONAL_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUBLISH_BRANCH: gh-pages
          PUBLISH_DIR: allure-history